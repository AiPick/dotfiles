let g:smooziee_scroll_interval='20'
let g:plugin_loader_roots = '~/.vimperator/vimperator-plugins'
let g:plugin_loader_plugins = 'open-with,feedSomeKeys_3,stylish,'
let g:plugin_loader_plugins .= 'goo.gl,_smooziee,caret-hint,imageextender,'
let g:plugin_loader_plugins .= 'proxy_command,firebug'
let g:powerline_seps = 'bookmark,tabcount,position,proxy'
let g:powerline_back_colors = '#2980b9,#e67e22,#1abc9c,#000000'
let g:powerline_fore_colors = '#000000,#000000,#000000,default'

source ~/.vimperator/vimperator-plugins/_libly.js
source ~/.vimperator/vimperator-plugins/plugin_loader.js

nnoremap Y :googleUrlShortener<CR>
nnoremap v :caret select head<CR>
nnoremap H :back<CR>
nnoremap L :forward<CR>
nnoremap [t :tabprevious<CR>
nnoremap ]t :tabnext<CR>
nnoremap D :tabclose!<CR>
nnoremap <silent> f :silent !fcitx-remote -c<CR>f
nnoremap <silent> F :silent !fcitx-remote -c<CR>F
nnoremap <silent> : :silent !fcitx-remote -c<CR>:
nnoremap <silent> b :silent !fcitx-remote -c<CR>b
nnoremap <silent> t :silent !fcitx-remote -c<CR>t
nnoremap <silent> o :silent !fcitx-remote -c<CR>o
nnoremap <C-L> :set gui=navigation<CR><C-L>
nnoremap <Esc> <Esc>:set gui=nonavigation<CR>
nnoremap <C-Q> <C-W>
nnoremap <C-Y> :js markdown_url()<CR>
cnoremap <C-N> <Down>
cnoremap <C-P> <Up>
cnoremap <C-Q> <Esc>

set hintchars=abcdefghijklmnopqrstuvwxyz
set suggestengines=''
set gui=nonavigation
set focuscontent
set wildmode=list:full
" set noscrollbars
set animations
colorscheme indigo

javascript <<EOM
function markdown_url() {
  var mdurl = '[' + buffer.title + '](' + buffer.URL + ')';
  util.copyToClipboard(mdurl);
  liberator.echo('copied:' + mdurl);
}

function toggle_flash() {
  var oldvar = options.getPref('plugin.state.flash');
  if (oldvar > 0)
    liberator.echo('flash-plugin disabled.');
  else
    liberator.echo('flash-plugin enabled.');
  options.setPref('plugin.state.flash', 2-oldvar);
}

function execute_if_no_flash(command) {
  if (options.getPref('plugin.state.flash') == 0)
    liberator.execute(command);
}

function toggle_proxy() {
  var pxtype = options.getPref('network.proxy.type');
  if (pxtype == 0)
    liberator.execute('proxy pac -reload file:///home/farseer/.proxy.pac');
  else
    liberator.execute('proxy direct');
}

function proxy_status() {
  if (!document.getElementById('liberator-status-proxy')) {
    var proxy_st = document.createElement('label');
    proxy_st.setAttribute('id', 'liberator-status-proxy');
    statusline._statuslineWidget.appendChild(proxy_st);
  }

  var pxObserver = {
    observe: function(subject, topic, data) {
      statusline.updateField('proxy');
    }
  }

  Services.prefs.addObserver('network.proxy.type', pxObserver, false);
  statusline.addField('proxy', 'proxy state', 'liberator-status-proxy',
    function updateProxy (node) {
      var pxtype = options.getPref('network.proxy.type');
      switch (pxtype) {
        case 0:
          node.value = '✘';
          node.style.color = '#d35400';
          break;
        case 1:
          node.value = 'M';
          node.style.color = '#95a5a6';
          break;
        case 2:
          node.value = '✔';
          node.style.color = '#2ecc71';
          break;
        case 4:
          node.value = 'A';
          break;
        case 5:
          node.value = 'S';
          break;
        default:
          node.value = 'U';
      }
    });
  statusline.updateField('proxy');
}

function power_arrow(id, right, full) {
  var pa = document.createElement('label');
  pa.setAttribute('id', 'liberator-status-pa-'+id);
  if (right) {
    pa.textContent = (full ? '' : '');
    pa.style.marginRight = '-1px';
  }
  else
    pa.textContent = (full ? '' : '');
  return pa;
}

function power_status() {
  var seperators = liberator.globalVariables.powerline_seps.split(',');
  var bcolors = liberator.globalVariables.powerline_back_colors.split(',');
  var fcolors = liberator.globalVariables.powerline_fore_colors.split(',');
  var widgets = options.get('status').value.split(',');
  var fields = statusline._statusfields;
  var cur = -1;
  for (var i=0; i < widgets.length; i++) {
    if (widgets[i] == seperators[cur+1]) {
      cur++;
      old_pa = document.getElementById('liberator-status-pa-'+widgets[i]);
      if (old_pa)
        statusline._statuslineWidget.removeChild(old_pa);
      var pa = power_arrow(widgets[i], 1, 1);
      pa.style.color = bcolors[cur];
      if (cur > 0)
        pa.style.background = bcolors[cur-1];
      statusline._statuslineWidget.insertBefore(pa, fields[widgets[i]].node);
    }
    if (cur > -1) {
      fields[widgets[i]].node.style.background = bcolors[cur];
      if (fcolors[cur] != 'default')
        fields[widgets[i]].node.style.color = fcolors[cur];
    }
  }
}
EOM

js proxy_status()
set status=location,ssl,bookmark,history,input,tabcount,position,proxy
js power_status()

autocmd!
autocmd PageLoad v\\.youku\\.com js execute_if_no_flash('youplayer')
autocmd PageLoad www\\.bilibili\\.com/video/av js execute_if_no_flash('bilidan')

command! pin :set apptab
command! unpin :set noapptab
command! youplayer :openwith youplayer
command! bilidan :openwith bilidan
command! chrome :openwith chromium
command! flashtoggle :js toggle_flash()
command! ss :js toggle_proxy()
nnoremap <C-F> :flashtoggle<CR>

fmaps -urls='feedly.com' j k <s-j> <s-k> n p o v r <s-m> gg ga
fmaps -urls='twitter.com' gh gn ga gr gd gp gf gl gm gs gu
ignorekeys add github\\.com -except=:,f,F,b,t,j,k,r,H,L,/,<Esc>
ignorekeys add inbox\\.google\\.com -except=:,f,F,b,t,r,/,<Esc>
" vim:ts=4:sw=4:tw=0:ft=vim:fdm=marker:foldmarker={,}
